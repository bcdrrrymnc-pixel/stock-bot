name: ğŸ“Š Stock Discord Notifier

on:
  schedule:
    # å¹³æ—¥ 8:00ã€œ18:00 JSTï¼ˆUTC 23:00ã€œ09:00ï¼‰ã‚’15åˆ†ã”ã¨
    # JST = UTC+9 ãªã®ã§ã€UTC 23:00ã€œ09:00 ãŒ JST 8:00ã€œ18:00
    - cron: "0,15,30,45 23-23 * * 0-4"   # æœˆã€œé‡‘ JST 8:00ã€œ8:45
    - cron: "0,15,30,45 0-8  * * 1-5"    # æœˆã€œé‡‘ JST 9:00ã€œ17:45
    - cron: "0,15,30,45 9    * * 1-5"    # æœˆã€œé‡‘ JST 18:00ã€œ18:45
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³

permissions:
  contents: write  # sent_ids.json ã®ã‚³ãƒŸãƒƒãƒˆã«å¿…è¦

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # â”€â”€â”€ 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ â”€â”€â”€
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      # â”€â”€â”€ 2. Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â”€â”€â”€
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # â”€â”€â”€ 3. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« â”€â”€â”€
      - name: Install dependencies
        run: pip install -r requirements.txt

      # â”€â”€â”€ 4. é€ä¿¡æ¸ˆã¿IDãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ â”€â”€â”€
      - name: Restore sent_ids cache
        uses: actions/cache@v4
        with:
          path: sent_ids.json
          key: sent-ids-${{ github.run_id }}
          restore-keys: |
            sent-ids-

      # â”€â”€â”€ 5. Botã‚’å®Ÿè¡Œ â”€â”€â”€
      - name: Run notifier
        env:
          DISCORD_EARNINGS_WEBHOOK: ${{ secrets.DISCORD_EARNINGS_WEBHOOK }}
          DISCORD_NEWS_WEBHOOK:     ${{ secrets.DISCORD_NEWS_WEBHOOK }}
          EDINET_API_KEY:           ${{ secrets.EDINET_API_KEY }}
        run: python earnings_notifier.py

      # â”€â”€â”€ 6. sent_ids.json ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦é‡è¤‡é˜²æ­¢ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ– â”€â”€â”€
      - name: Commit sent_ids.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sent_ids.json
          git diff --staged --quiet || git commit -m "chore: update sent_ids [skip ci]"
          git push
