name: ğŸ“Š Stock Discord Notifier

on:
  schedule:
    # å¹³æ—¥ 8:00ã€œ18:55 JST ã‚’5åˆ†ã”ã¨ï¼ˆUTC-9æ™‚é–“ï¼‰
    - cron: "*/5 23 * * 0-4"     # æœˆã€œé‡‘ JST 8:00ã€œ8:55
    - cron: "*/5 0-8 * * 1-5"    # æœˆã€œé‡‘ JST 9:00ã€œ17:55
    - cron: "*/5 9 * * 1-5"      # æœˆã€œé‡‘ JST 18:00ã€œ18:55
  workflow_dispatch:

permissions:
  contents: write

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run notifier
        env:
          DISCORD_EARNINGS_WEBHOOK: ${{ secrets.DISCORD_EARNINGS_WEBHOOK }}
          DISCORD_NEWS_WEBHOOK:     ${{ secrets.DISCORD_NEWS_WEBHOOK }}
          EDINET_API_KEY:           ${{ secrets.EDINET_API_KEY }}
        run: python earnings_notifier.py

      - name: Commit sent_ids.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sent_ids.json
          git diff --staged --quiet || git commit -m "chore: update sent_ids [skip ci]"
          git push
