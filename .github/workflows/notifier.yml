name: ğŸ“Š Stock Discord Notifier

on:
  schedule:
    - cron: "0,15,30,45 23 * * 0-4"      # æœˆã€œé‡‘ JST 8:00ã€œ8:45
    - cron: "0,15,30,45 0-8  * * 1-5"    # æœˆã€œé‡‘ JST 9:00ã€œ17:45
    - cron: "0,15,30,45 9    * * 1-5"    # æœˆã€œé‡‘ JST 18:00ã€œ18:45    # æœˆã€œé‡‘ JST 18:00ã€œ18:45
  workflow_dispatch:

permissions:
  contents: write

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      # sent_ids.json ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ã¯ãªãGitãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†
      # â†’ ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹æœ€æ–°ã®sent_ids.jsonã‚’ãã®ã¾ã¾ä½¿ã†ï¼ˆcheckoutæ¸ˆã¿ï¼‰

      - name: Run notifier
        env:
          DISCORD_EARNINGS_WEBHOOK: ${{ secrets.DISCORD_EARNINGS_WEBHOOK }}
          DISCORD_NEWS_WEBHOOK:     ${{ secrets.DISCORD_NEWS_WEBHOOK }}
          EDINET_API_KEY:           ${{ secrets.EDINET_API_KEY }}
        run: python earnings_notifier.py

      - name: Commit sent_ids.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sent_ids.json
          git diff --staged --quiet || git commit -m "chore: update sent_ids [skip ci]"
          git push
